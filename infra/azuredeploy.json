{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "environmentVariables": {
        "type": "object",
        "defaultValue": {
          "APP_PORT": "8080",
          "DATABASE_URL": "mysql://user:password@dbhost/dbname"
        },
        "metadata": {
          "description": "Environment variables for Docker Compose"
        }
      }
    },
    "resources": [
      {
        "type": "Microsoft.Network/virtualNetworks",
        "apiVersion": "2021-05-01",
        "name": "dockervm-vnet",
        "location": "[resourceGroup().location]",
        "properties": {
          "addressSpace": {
            "addressPrefixes": [
              "10.0.0.0/16"
            ]
          },
          "subnets": [
            {
              "name": "default",
              "properties": {
                "addressPrefix": "10.0.1.0/24"
              }
            }
          ]
        }
      },
      {
        "type": "Microsoft.Network/networkInterfaces",
        "apiVersion": "2021-05-01",
        "name": "dockervm-nic",
        "location": "[resourceGroup().location]",
        "properties": {
          "ipConfigurations": [
            {
              "name": "ipconfig1",
              "properties": {
                "subnet": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', 'dockervm-vnet', 'default')]"
                }
              }
            }
          ]
        }
      },
      {
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2021-04-01",
        "name": "docker-vm",
        "dependsOn": [
          "dockervm-nic"
        ],
        "properties": {
          "mode": "Incremental",
          "expressionEvaluationOptions": {
            "scope": "inner"
          },
          "template": {
            "contentVersion": "1.0.0.0",
            "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
            "resources": [
              {
                "type": "Microsoft.Compute/virtualMachines",
                "apiVersion": "2021-07-01",
                "name": "dockervm-template",
                "location": "[resourceGroup().location]",
                "properties": {
                  "hardwareProfile": {
                    "vmSize": "Standard_B1s"
                  },
                  "osProfile": {
                    "computerName": "docker-vm",
                    "adminUsername": "azureuser",
                    "adminPassword": "OpenMined123!",
                    "customData": "[base64(concat('#!/bin/bash\n', variables('installDockerScript')))]"
                  },
                  "storageProfile": {
                    "imageReference": {
                      "publisher": "Canonical",
                      "offer": "0001-com-ubuntu-server-focal",
                      "sku": "20_04-lts",
                      "version": "latest"
                    },
                    "osDisk": {
                      "createOption": "FromImage"
                    }
                  },
                  "networkProfile": {
                    "networkInterfaces": [
                      {
                        "id": "[resourceId('Microsoft.Network/networkInterfaces', 'dockervm-nic')]"
                      }
                    ]
                  }
                }
              }
            ],
            "variables": {
              "installDockerScript": "'sudo apt update && sudo apt install -y docker.io docker-compose && sudo systemctl enable --now docker'"
            }
          }
        }
      }
    ]
  }
  